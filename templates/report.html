{% extends "base.html" %}

{% block title %}{{ report.title }} - Market Research Report{% endblock %}

{% block extra_head %}
<meta name="description" content="Market research report for {{ report.industry }}{% if report.geography %} in {{ report.geography }}{% endif %}">
<meta property="og:title" content="{{ report.title }}">
<meta property="og:description" content="AI-generated market research report for {{ report.industry }}">
<meta property="og:type" content="article">
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <!-- Report Header -->
        <div class="d-flex justify-content-between align-items-start mb-4">
            <div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="{{ url_for('index') }}">
                                <i class="fas fa-home me-1"></i>Home
                            </a>
                        </li>
                        <li class="breadcrumb-item active">{{ report.title }}</li>
                    </ol>
                </nav>
                <h1 class="display-5 fw-bold text-orange mb-1 gerstner">{{ report.title }}</h1>
                <p class="text-muted mb-0">
                    <i class="fas fa-calendar me-2"></i>Generated on {{ report.created_at }}
                </p>
            </div>
            <div class="btn-group" role="group">
                <a href="{{ url_for('download_report', slug=report.slug) }}" 
                   class="btn btn-outline-primary">
                    <i class="fas fa-download me-2"></i>Download Markdown
                </a>
                <button class="btn btn-outline-secondary" onclick="window.print()">
                    <i class="fas fa-print me-2"></i>Print
                </button>
                <button class="btn btn-outline-info" onclick="copyReportUrl()">
                    <i class="fas fa-share me-2"></i>Share
                </button>
            </div>
        </div>

        <!-- Report Metadata -->
        <div class="card border-0 bg-light mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <h6 class="stat-label">
                            <i class="fas fa-industry me-2 text-orange"></i>Industry
                        </h6>
                        <p class="mb-0">{{ report.industry }}</p>
                    </div>
                    <div class="col-md-3">
                        <h6 class="stat-label">
                            <i class="fas fa-globe me-2 text-orange"></i>Geography
                        </h6>
                        <p class="mb-0">{{ report.geography or 'Global' }}</p>
                    </div>
                    <div class="col-md-3">
                        <h6 class="stat-label">
                            <i class="fas fa-search me-2 text-orange"></i>Research Focus
                        </h6>
                        <p class="mb-0">{{ report.details or 'General market analysis' }}</p>
                    </div>
                    <div class="col-md-3">
                        <h6 class="stat-label">
                            <i class="fas fa-user me-2 text-orange"></i>Author
                        </h6>
                        <p class="mb-0">{{ report.author_name or 'Anonymous' }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Content with Table of Contents -->
        <div class="row">
            <!-- Table of Contents Sidebar -->
            <div class="col-lg-3">
                <div class="toc-sidebar" id="table-of-contents">
                    <div class="toc-header">
                        <h5><i class="fas fa-list me-2"></i>Table of Contents</h5>
                    </div>
                    <nav class="toc-nav" id="toc-nav">
                        <!-- TOC items will be generated automatically -->
                    </nav>
                </div>
            </div>
            
            <!-- Main Report Content -->
            <div class="col-lg-9">
                <div class="card shadow-sm">
                    <div class="card-header bg-white border-bottom">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="card-title mb-0">
                                <i class="fas fa-file-alt me-2 text-orange"></i>Market Research Report
                            </h4>
                            <span class="badge bg-orange">
                                <i class="fas fa-robot me-1"></i>AI Generated
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="report-content" class="markdown-content">
                            {{ report.content | safe }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Footer -->
        <div class="card border-0 bg-light mt-4">
            <div class="card-body text-center">
                <p class="mb-2">
                    <i class="fas fa-robot me-2 text-orange"></i>
                    <strong>Generated by AI-powered Deep Research Technology</strong>
                </p>
                <small class="text-muted">
                    This report was generated using Parallel's deep research capabilities with comprehensive web analysis and citation tracking.
                </small>
                <div class="mt-3">
                    <a href="{{ url_for('index') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Generate Another Report
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Share URL Modal -->
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-share me-2"></i>Share Report
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Share this report using the link below:</p>
                <div class="input-group">
                    <input type="text" class="form-control" id="share-url" readonly>
                    <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard()">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
                <small class="text-muted">This report is publicly accessible via this URL.</small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Include marked.js for better markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked@5.1.1/marked.min.js"></script>
<script>
// Enhanced markdown formatting with table of contents generation
document.addEventListener('DOMContentLoaded', function() {
    const content = document.getElementById('report-content');
    if (content) {
        const markdownText = content.textContent || content.innerText;
        
        // Configure marked options for better parsing
        marked.setOptions({
            breaks: true,
            gfm: true, // GitHub Flavored Markdown
            tables: true,
            sanitize: false
        });
        
        // Custom renderer to handle citations and add IDs to headings
        const renderer = new marked.Renderer();
        
        // Override heading renderer to add IDs for TOC
        renderer.heading = function(text, level) {
            const escapedText = text.toLowerCase().replace(/[^\w\s]+/g, '').replace(/\s+/g, '-').replace(/^-+|-+$/g, '');
            const id = `heading-${escapedText}`;
            
            // Apply proper heading classes based on level
            let headingClass = 'report-heading';
            if (level === 1) headingClass += ' text-orange';
            else if (level === 2) headingClass += ' text-orange';
            
            return `<h${level} id="${id}" class="${headingClass}">${text}</h${level}>`;
        };
        
        // Override table renderer for better styling
        renderer.table = function(header, body) {
            return `
                <div class="table-responsive mb-4">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">${header}</thead>
                        <tbody>${body}</tbody>
                    </table>
                </div>
            `;
        };
        
        // Override list renderer for better styling
        renderer.listitem = function(text) {
            return `<li class="mb-2">${text}</li>`;
        };
        
        marked.use({ renderer });
        
        // Parse markdown content
        let html = marked.parse(markdownText);
        
        // Handle citations - convert [1], [2], etc. to clickable links
        html = html.replace(/\[(\d+)\]/g, function(match, num) {
            return `<a href="#citation-${num}" class="citation-link" data-citation="${num}">[${num}]</a>`;
        });
        
        // Process references section to add citation anchors
        // Look for references patterns more flexibly
        html = html.replace(/(\n|^)(\d+)\.\s+(.+?)(?=\n\d+\.|\n\n|\n$|$)/gm, function(match, prefix, num, text) {
            return `${prefix}<div id="citation-${num}" class="citation-item"><strong>[${num}]</strong> ${text.trim()}</div>`;
        });
        
        // Also handle references in a "References" section
        html = html.replace(/(references|sources|bibliography)/i, function(match) {
            return `<div id="references-section">${match}</div>`;
        });
        
        // Set the processed HTML
        content.innerHTML = html;
        
        // Generate table of contents
        generateTableOfContents();
        
        // Initialize citation click handlers
        initializeCitationHandlers();
        
        // Initialize smooth scrolling for TOC
        initializeSmoothScrolling();
    }
});

function generateTableOfContents() {
    // Only include H1 and H2 headings for a cleaner TOC
    const headings = document.querySelectorAll('#report-content h1, #report-content h2');
    const tocNav = document.getElementById('toc-nav');
    
    if (headings.length === 0) {
        document.getElementById('table-of-contents').style.display = 'none';
        return;
    }
    
    let tocHTML = '<ul class="toc-list">';
    
    headings.forEach((heading, index) => {
        const level = parseInt(heading.tagName.substring(1));
        const text = heading.textContent;
        const id = heading.id || `heading-${index}`;
        
        if (!heading.id) {
            heading.id = id;
        }
        
        // Apply different styling for H1 vs H2
        const itemClass = level === 1 ? 'toc-item toc-main-title' : 'toc-item toc-section';
        const linkClass = level === 1 ? 'toc-link toc-link-main' : 'toc-link toc-link-section';
        
        tocHTML += `
            <li class="${itemClass}">
                <a href="#${id}" class="${linkClass}" data-target="${id}">
                    ${text}
                </a>
            </li>
        `;
    });
    
    tocHTML += '</ul>';
    tocNav.innerHTML = tocHTML;
}

function initializeCitationHandlers() {
    document.querySelectorAll('.citation-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const citationId = this.getAttribute('data-citation');
            const target = document.getElementById(`citation-${citationId}`);
            
            if (target) {
                // Simple scroll to target
                target.scrollIntoView({ block: 'center' });
            }
        });
    });
}


function initializeSmoothScrolling() {
    document.querySelectorAll('.toc-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('data-target');
            const target = document.getElementById(targetId);
            
            if (target) {
                // Update active state
                document.querySelectorAll('.toc-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                
                // Smooth scroll
                target.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start',
                    inline: 'nearest'
                });
            }
        });
    });
    
    // Update active TOC item on scroll
    window.addEventListener('scroll', updateActiveTocItem);
}

function updateActiveTocItem() {
    // Only track H1 and H2 headings for TOC highlighting
    const headings = document.querySelectorAll('#report-content h1, #report-content h2');
    const tocLinks = document.querySelectorAll('.toc-link');
    
    let activeHeading = null;
    const scrollTop = window.pageYOffset;
    
    headings.forEach(heading => {
        if (heading.offsetTop <= scrollTop + 100) {
            activeHeading = heading;
        }
    });
    
    if (activeHeading) {
        tocLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('data-target') === activeHeading.id) {
                link.classList.add('active');
            }
        });
    }
}

function copyReportUrl() {
    const url = window.location.href;
    document.getElementById('share-url').value = url;
    const shareModal = new bootstrap.Modal(document.getElementById('shareModal'));
    shareModal.show();
}

function copyToClipboard() {
    const shareUrl = document.getElementById('share-url');
    shareUrl.select();
    shareUrl.setSelectionRange(0, 99999);
    
    try {
        document.execCommand('copy');
        
        // Show success feedback
        const button = event.target.closest('button');
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check text-success"></i>';
        
        setTimeout(() => {
            button.innerHTML = originalHTML;
        }, 2000);
        
    } catch (err) {
        console.error('Failed to copy URL:', err);
        alert('Failed to copy URL. Please copy manually.');
    }
}

// Print styles
window.addEventListener('beforeprint', function() {
    document.body.classList.add('printing');
});

window.addEventListener('afterprint', function() {
    document.body.classList.remove('printing');
});
</script>

<style>
/* Print styles */
@media print {
    .btn-group, .breadcrumb, nav, footer {
        display: none !important;
    }
    
    .card {
        border: none !important;
        box-shadow: none !important;
    }
    
    .card-header {
        background: none !important;
        border: none !important;
    }
    
    body.printing {
        font-size: 12pt;
        line-height: 1.5;
    }
}

/* Markdown content styling */
.markdown-content {
    line-height: 1.7;
    font-size: 1.1rem;
}

.markdown-content h2 {
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: 0.5rem;
}

.markdown-content h3 {
    color: #495057;
}

.markdown-content ul {
    padding-left: 1.5rem;
}

.markdown-content li {
    margin-bottom: 0.5rem;
}

.markdown-content p {
    text-align: justify;
}
</style>
{% endblock %}
